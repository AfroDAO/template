jQuery(document).ready(function($) {

  let entered = false, interval = null;
  $('#wpse1_2023_btn').on('click', wpse1_2023_btn);
  $('#wpse1_2023_install_btn').on('click', wpse1_2023_btn_install);
  $('#wpse1_2023_btn').on('mouseenter', wpse1_2023_show);
  $('#wpse1_2023_btn').on('mouseleave', wpse1_2023_hide);
  $('#wpse1_2023_wpclone_show').on('click', wpse1_2023_move);

  function hideIt() {
    $('#wpse1_2023_who').hide(300);
    $('#wpse1_2023').css({
      'overflow': 'hidden',
      'max-height': $('#wpse1_2023').height(),
      'max-width': $('#wpse1_2023').width(),
      'opacity': 1
    });

    $('#wpse1_2023').animate({'max-height': '0px', 'opacity': '0', 'padding-top': '0', 'padding-bottom': '0', 'margin-top': '0'}, 300, function () {
      setTimeout(() => { $('#wpse1_2023').remove(); }, 10);
    });
  }
  function wpse1_2023_btn() {
    setTimeout(() => { hideIt(); }, 100);
    $.post(ajaxurl, { action: 'wpse1_2023_btn' });
  }
  function wpse1_2023_btn_install() {

    $('#wpse1_2023_install_btn').css({'pointer-events': 'none', 'opacity': '.6'});
    $('#wpse1_2023_btns').addClass('wpse1_2023_btns_installing');
    $('#wpse1_2023_other').css({'max-width': `${$('#wpse1_2023_other').width()}px`, 'max-height': `${$('#wpse1_2023_other').height()}px`, 'overflow': 'hidden'});
    $('#wpse1_2023_show').css({'max-width': `${$('#wpse1_2023_show').width()}px`, 'overflow': 'hidden'});
    $('#wpse1_2023_dismiss').css({'max-width': `${$('#wpse1_2023_dismiss').width()}px`, 'overflow': 'hidden'});
    $('#wpse1_2023_other').animate({'padding-left': '0', 'max-width': '0'}, 500, function () {
      $('#wpse1_2023_btns, #wpse1_2023_install').css({'float': 'left', 'width': '200px'});
      $('#wpse1_2023_install').find('span').hide(300);
      $('#wpse1_2023_other').hide();
    });

    $('#wpse1_2023_text').css({'opacity': '1'});
    $('#wpse1_2023_text').animate({'opacity': '0'}, 500, function () {
      $('#wpse1_2023_text').css({'line-height': '21px'});
      $('#wpse1_2023_install_btn').text('Installing...');
      $('#wpse1_2023_text').html(`We\'re downloading this awesome plugin!<br>We will redirect you soon, please wait<span id="wpse1_2023_dots">...</span> :)`);
      $('#wpse1_2023_text').animate({'opacity': '1'}, 500, function () {
        let dox = '..', predox = '...';
        interval = setInterval(() => {
          $('#wpse1_2023_dots').text(dox);

          // I named it DOXPARADOX <3
          if (dox == '..' && predox == '...') { dox = '.'; predox = '..' }
          else if (dox == '.' && predox == '...') { dox = '..'; predox = '.' }
          else if (dox == '..' && predox == '..') { dox = '...'; predox = '..' }
          else if (dox == '.' && predox == '..') { dox = '..'; predox = '.' }
          else if (dox == '..' && predox == '.') { dox = '...'; predox = '..' }
          else { dox = '..'; predox = '...' }
        }, 600);
      });
    });

    $('#wpse1_2023_btns, #wpse1_2023_install').css({'text-align': 'left'});
    $('#wpse1_2023_show, #wpse1_2023_dismiss').css({'overflow': 'hidden', 'text-align': 'left'});

    $.post(ajaxurl, { action: 'wpse1_2023_install' }).done((res) => {

      clearInterval(interval);
      setTimeout(function () {
        if (isJsonString(res)) res = cdpParse(res);
        let url = $('#wpse1_2023').data('url');
        if (res.status == 'success') {
          window.location = res.url;
        }
        else if (typeof res.url != 'undefined') handleIssue();
        else handleIssue();
      }, 500);

    }).fail(() => { handleIssue(); });

    function handleIssue() {
      clearInterval(interval);

      $('#wpse1_2023_text').animate({'opacity': '0'}, 500, function () {
        $('#wpse1_2023_text').html(`There was an error during plugin download :(<br>Please try to do it manualy, we will redirect you in <span id="wpse1_2023_nums">3</span>s.`);
        $('#wpse1_2023_text').animate({'opacity': '1'}, 500, function () {
          let i = 3;
          clearInterval(interval);
          interval = setInterval(() => {
            i--;
            $('#wpse1_2023_nums').text(i);
            if (i == 0) {
              let url = $('#wpse1_2023').data('url');
              window.location.href = `${url}/wp-admin/plugin-install.php?s=Migrate&tab=search&type=author`;
            }
          }, 1050);
        });
      });

    }

  }
  function wpse1_2023_show() {
    $('#wpse1_2023_smile').css({'opacity': 1});
  }
  function wpse1_2023_hide() {
    $('#wpse1_2023_smile').css({'opacity': 0});
  }
  function wpse1_2023_move() {
    $('#wpse1_2023_wpclone').hide(300);
    $('#wpse1_2023_complete').hide(300);
    setTimeout(function () {
      $('#wpse1_2023_complete').prependTo('#wpbody-content');
      $('#wpse1_2023_complete').show(300);
    }, 310);
  }

  function isJsonString(str) {
    try { JSON.parse(str); }
    catch (e) {
      if (typeof str === 'string') {
        let reversed = cdpReverseString(str);
        let lastcorrect = reversed.indexOf('}');
        if (lastcorrect == 0) lastcorrect = str.length;
        else lastcorrect = -lastcorrect;

        str = str.slice(str.indexOf('{'), lastcorrect);

        try {
          JSON.parse(str);
        } catch (e) {
          return false;
        }
        return true;
      } else return false;
    }
    return true;
  }
  function cdpReverseString(str) {
    if (typeof str === 'string')
      return (str === '') ? '' : cdpReverseString(str.substr(1)) + str.charAt(0);
    else
      return str;
  }
  function cdpParse(str) {
    try { JSON.parse(str); }
    catch (e) {
      if (typeof str === 'string') {
        let reversed = cdpReverseString(str);
        let lastcorrect = reversed.indexOf('}');
        if (lastcorrect == 0) lastcorrect = str.length;
        else lastcorrect = -lastcorrect;
        str = str.slice(str.indexOf('{'), lastcorrect);
        try {
          JSON.parse(str);
        } catch (e) {
          return false;
        }
        return JSON.parse(str);
      } else return false;
    }
    return JSON.parse(str);
  }

});
