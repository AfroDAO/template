var PTB;(function(c,b,a,d){PTB={prefix:"ptb_",template_type:false,init:function(e){e=c.extend({prefix:this.prefix,template_type:this.template_type},e);this.prefix=e.prefix;this.template_type=e.template_type;this.Undelegate();this.bindEvents()},Undelegate:function(){c(a).off("change click")},bindEvents:function(){this.SetupColors();this.SelectGrid();this.InitDraggable();this.InitSortable();this.Open();this.AddRow();this.Delete();this.Save();this.Validate();this.ShowHideSeperator();this.InitTMCE();this.InitDefaultContent();this.AddIcon();this.DisableItems();InitLanguageTabs();c.event.trigger("PTB.template_load",this.template_type)},SelectGrid:function(){c(a).on("click","."+PTB.prefix+"column_select",function(o){o.preventDefault();c(this).closest("."+PTB.prefix+"grid_list_wrapper").find("li.selected").removeClass("selected");c(this).closest("li").addClass("selected");var u='"'+c(this).data("grid")+'"';u=JSON.parse(u).split(",");var q=c(this).closest("."+PTB.prefix+"back_row"),t=q.find("."+PTB.prefix+"back_col");t.removeAttr("class").addClass(PTB.prefix+"back_col").hide();var s=q.find("."+PTB.prefix+"back_module"),g=u.length,p=s.length,l=p>g?Math.ceil(p/g):1,r=[];if(s.length>0){var f=s.find(".wp-editor-area");if(f.length>0&&typeof tinymce!=="undefined"){f.each(function(){var i=c(this).attr("id");if(tinyMCEPreInit.mceInit[i]){r[i]=PTB.GetEditorContent(i)}})}}for(var n=0;n<g;n++){var w=c(t[n]);var k=PTB.prefix+"col"+u[n]+" "+PTB.prefix+"show_grid";w.attr("data-grid",u[n]);if(n===0){k+=" first"}if(s.length>0){var h=w.find("."+PTB.prefix+"module_holder").first();h.find("."+PTB.prefix+"back_module").remove();for(var m=0;m<l;m++){if(!s[m]){break}h.append(s[m])}s.splice(0,l)}w.addClass(k).show()}for(var v in r){if(tinyMCEPreInit.mceInit[v]){tinymce.execCommand("mceRemoveEditor",false,v);c("#"+v).ptb_wp_editor();tinymce.execCommand("mceAddEditor",false,v);PTB.SetEditorContent(v,r[v])}}PTB.DestroyInputColor();PTB.SetInputColor(c("#"+PTB.prefix+"row_wrapper").find("."+PTB.prefix+"color_picker"));c.event.trigger("PTB.template_select_grid",[PTB.template_type,u])});if(c("."+PTB.prefix+"grid_list li.selected").length===0){c("."+PTB.prefix+"column_select").first().trigger("click")}else{c("."+PTB.prefix+"back_row_content ."+PTB.prefix+"back_col[data-grid]").show();this.PlaceHoldDragger();PTB.Unique(c("#"+PTB.prefix+"row_wrapper ."+PTB.prefix+"active_module"));if(typeof tinymce!=="undefined"){var e=c("#"+PTB.prefix+"row_wrapper ."+PTB.prefix+"wp_editor");e.each(function(){var f=PTB.GenerateUnique();c(this).attr("id",f).ptb_wp_editor();if(tinyMCEPreInit.mceInit[f]){tinymce.execCommand("mceAddEditor",false,f)}})}PTB.SetInputColor(c("#"+PTB.prefix+"row_wrapper").find("."+PTB.prefix+"color_picker"))}},PlaceHoldDragger:function(){c("."+PTB.prefix+"module_holder").each(function(){var e=c(this).find("."+PTB.prefix+"empty_holder_text");if(c(this).find("."+PTB.prefix+"active_module").length===0){e.show()}else{e.hide()}})},equalHeight:function(f){var g=f.find("."+PTB.prefix+"back_col:visible");if(g.length>1){g.css("min-height","initial");var e=c(g[0]).height();g.each(function(){if(c(this).height()>e){e=c(this).height()}});g.css("min-height",e)}},InitDraggable:function(){c("."+PTB.prefix+"back_module_panel ."+PTB.prefix+"back_module").draggable({appendTo:"body",helper:"clone",revert:"invalid",snapMode:"inner",connectToSortable:"."+PTB.prefix+"module_holder",stop:function(h,g){var f=c(g.helper[0]);c.event.trigger("PTB.template_drag_start",[f,g,PTB.template_type]);PTB.Unique(f);if(f.data("type")=="custom_text"){var i=f.find("textarea."+PTB.prefix+"wp_editor");i.each(function(){var e=PTB.GenerateUnique();c(this).attr("id",e);c("#"+e).ptb_wp_editor();setTimeout(function(){c("#wp-"+e+"-wrap").find(".switch-html").trigger("click")},1200)})}else{PTB.SetInputColor(f.find("."+PTB.prefix+"color_picker"))}f.find("."+PTB.prefix+"toggle_module").trigger("click");c.event.trigger("PTB.template_drag_end",[f,g,PTB.template_type])}})},InitSortable:function(){c("."+PTB.prefix+"module_holder").sortable({placeholder:PTB.prefix+"ui_state_highlight",items:"."+PTB.prefix+"back_module",connectWith:"."+PTB.prefix+"module_holder",cursor:"move",revert:100,sort:function(e,f){var g=f.item.outerHeight();c("."+PTB.prefix+"module_holder ."+PTB.prefix+"ui_state_highlight").height(g)},receive:function(e,f){PTB.PlaceHoldDragger();c(this).parent().find("."+PTB.prefix+"empty_holder_text").hide()},start:function(e,f){c(f.item).removeClass(PTB.prefix+"dragged")},stop:function(f,g){var e=c(g.item);e.addClass(PTB.prefix+"dragged");PTB.equalHeight(e.closest("."+PTB.prefix+"back_row"));if(typeof tinymce!=="undefined"){var h=e.find("textarea."+PTB.prefix+"wp_editor");h.each(function(){var i=c(this).attr("id");if(tinyMCEPreInit.mceInit[i]){tinymce.execCommand("mceRemoveEditor",false,i);tinymce.execCommand("mceAddEditor",false,i);PTB.ActiveEdiror(i)}})}}});c("#"+PTB.prefix+"row_wrapper").sortable({items:"."+PTB.prefix+"back_row",handle:"."+PTB.prefix+"back_row_top",axis:"y",placeholder:PTB.prefix+"ui_state_highlight",sort:function(g,f){var h=f.item.height();c("#"+PTB.prefix+"row_wrapper ."+PTB.prefix+"ui_state_highlight").height(h)}})},Open:function(){c(a).on("click","."+PTB.prefix+"toggle_module,."+PTB.prefix+"toggle_row",function(g){var i=c(this).closest("."+PTB.prefix+"active_module").length===0?c(this).closest("."+PTB.prefix+"back_row").find("."+PTB.prefix+"back_row_content"):c(this).closest("."+PTB.prefix+"active_module").find("."+PTB.prefix+"back_active_module_content");var f=i.closest("."+PTB.prefix+"back_col"),h="."+PTB.prefix+'back_col[data-grid][class~="'+PTB.prefix+'back_col"][class*="'+PTB.prefix+'col"]';if(c(this).hasClass(PTB.prefix+"opened")||i.is(":visible")){c(this).removeClass(PTB.prefix+"opened");if(f.length>0&&f.find("."+PTB.prefix+"opened").length==0){f.removeClass("shadow",400,function(){i.slideUp(400,function(){f.removeClass("fill",400,"swing",function(){f.removeClass("fill");f.siblings(h).show(400);f.find("."+PTB.prefix+"delete_module").show();c("."+PTB.prefix+"module_holder").sortable("enable")})})})}else{i.slideUp()}}else{c(this).addClass(PTB.prefix+"opened");if(f.length>0&&f.siblings(h).length!==0){f.siblings(h).hide(400,function(){f.addClass("fill");f.find("."+PTB.prefix+"delete_module").hide();i.slideDown(400,function(){f.addClass("shadow");c("."+PTB.prefix+"module_holder").sortable("disable")})})}else{i.slideDown()}}g.preventDefault()})},Delete:function(){c(a).on("click","."+PTB.prefix+"delete_module",function(g){if(confirm(ptb_js.module_delete)){var h=c(this).closest("."+PTB.prefix+"active_module").length===0?c(this).closest("."+PTB.prefix+"back_row"):c(this).closest("."+PTB.prefix+"back_module"),f=h.closest("."+PTB.prefix+"back_row");h.remove();if(f.length>0){PTB.PlaceHoldDragger();PTB.equalHeight(f)}}g.preventDefault()})},AddRow:function(){c("."+PTB.prefix+"add_row").click(function(g){var f=c("."+PTB.prefix+"first_row").first().clone();f.removeClass(PTB.prefix+"first_row").find("."+PTB.prefix+"back_module").remove();f.find("."+PTB.prefix+"empty_holder_text").show();f.find("."+PTB.prefix+"row_custom_css ").val("");f.find("."+PTB.prefix+"back_col").css("min-height","initial");c("."+PTB.prefix+"back_row").last().after(f);f.find("."+PTB.prefix+"column_select").first().trigger("click");g.preventDefault();PTB.InitSortable()})},Save:function(){c("#"+PTB.prefix+"submit").click(function(j){var f=c(".ptb_toggle_module.ptb_opened"),h=0;if(f.length>0){f.click();h=1500}var g=c(this).closest("form"),i=c("."+PTB.prefix+"back_builder").find("input,select,textarea");i.attr("disabled","disabled");setTimeout(function(){var e=PTB.ParseData();c.event.trigger("PTB.before_template_save",e);var e=JSON.stringify(e);c("#"+PTB.prefix+"layout").val(e);c.ajax({url:g.attr("action"),method:"POST",dataType:"json",data:g.serialize(),beforeSend:function(){g.addClass(PTB.prefix+"wait")},complete:function(){i.removeAttr("disabled");g.removeClass(PTB.prefix+"wait")},success:function(k){if(k&&k.status=="1"){c("#"+PTB.prefix+"success_text").html("<p><strong>"+k.text+"</strong></p>").show();setTimeout(function(){c("#"+PTB.prefix+"success_text").html("").hide()},2000);c.event.trigger("PTB.after_template_save")}}})},h);j.preventDefault()})},Validate:function(){var e=c('input[name="'+PTB.prefix+'ptt_offset_post"]');e.keypress(function(f){var g=(f.which)?f.which:f.keyCode;if(g!=46&&g>31&&(g<48||g>57)){return false}return true});c('input[name="'+PTB.prefix+'ptt_pagination_post"]').change(function(f){if(c(this).val()==0){e.attr("disabled","disabled")}else{e.removeAttr("disabled")}});c('input[name="'+PTB.prefix+'ptt_pagination_post"]:checked').trigger("change")},ParseData:function(){var g=c("#"+PTB.prefix+"row_wrapper"),f=g.find("."+PTB.prefix+"back_row"),e={};f.each(function(h){e[h]={};e[h]["row_classes"]=c.trim(c(this).find("."+PTB.prefix+"row_custom_css").val());var j=c(this).find("."+PTB.prefix+"show_grid");j.each(function(m){var l=c(this).attr("data-grid"),n=l+"-"+m;e[h][n]={};var i=c(this).find("."+PTB.prefix+"back_active_module_content");i.each(function(o){var k=c(this).data("type");e[h][n][o]={};e[h][n][o]["type"]=k;var p=c(this).find('input:checked,input[type="text"],input[type="number"],input[type="hidden"],textarea,select');p.each(function(){var y=c(this).attr("name");if(y){var x=y.split("]");if(x){x.pop();var s=[],q=false;for(var v in x){var u=x[v].split("[");if(u[1]){s[v]=u[1]}}q=s[2]==="arr";e[h][n][o]["key"]=s[0];if(!q&&(!e[h][n][o][s[1]]||s[2])){if(s[2]){var r=s[2];if(typeof e[h][n][o][s[1]]!=="object"){e[h][n][o][s[1]]={}}e[h][n][o][s[1]][r]=k!=="custom_text"?c(this).val():PTB.GetEditorContent(c(this).attr("id"))}else{var w=false;if(c(this).hasClass(PTB.prefix+"color_picker")){w=c(this).minicolors("rgbaString");w=w==="rgba(0, 0, 0, 1)"?false:w}else{w=c(this).val()==="on"?true:c(this).val()}e[h][n][o][s[1]]=w}}else{if(!q){if(typeof e[h][n][o][s[0]]!=="object"&&typeof e[h][n][o][s[1]]!=="object"){var t=e[h][n][o][s[1]];e[h][n][o][s[1]]=[];e[h][n][o][s[1]][0]=t}e[h][n][o][s[1]].push(c(this).val())}else{e[h][n][o][s[1]]=c(this).val();if(!e[h][n][o][s[1]]){e[h][n][o][s[1]]=[]}}}}}})})})});return e},Unique:function(e){e.each(function(){var l=c(this),f=l.find("label");f.each(function(){var q=c(this).attr("for");if(q){q=PTB.Escape(c(this).attr("for"));if(c("#"+q).length>0){var p=PTB.GenerateUnique();l.find("#"+q).attr("id",p);c(this).attr("for",p)}}});var m=/.*?\[(.+?)\]/ig,k=l.find('input[type="radio"]'),h={};k.each(function(q){var p=c(this).attr("name");if(p){h[p]=1}});for(var n in h){var i=n.match(m);if(i){var j=PTB.GenerateUnique(),g=l.find('input:radio[name="'+n+'"]'),o=j+i[0]+i[1];g.attr("name",o);if(l.find('input:radio[name!="'+n+'"]')){l.find('input:radio[name="'+o+'"][checked]').prop("checked",true)}}}})},DisableItems:function(){c(a).on("change",'.ptb_change_disable input[type="radio"],.ptb_change_disable input[type="checkbox"],.ptb_change_disable select',function(){var e=c(this).closest(".ptb_change_disable").data("disabled");if(e||e=="0"){e=e.toString().split(",");if(!c.isArray(e)){e=[e]}var f=c(this).is(":checkbox")||c(this).is(":radio")?c(this).is(":checked"):1,h=c(this).is(":checkbox")&&c(this).closest(".ptb_back_active_module_input").find('input[type="checkbox"]').length===1?(f?"0":"1"):c(this).val(),i=c(this).closest(".ptb_change_disable").data("action"),g=c(this).closest(".ptb_lightbox_row").length>0?c(this).closest(".ptb_lightbox_row_wrapper").find(".ptb_maybe_disabled"):c(this).closest(".ptb_back_active_module_content").find(".ptb_maybe_disabled");if(c(this).closest(".ptb_back_active_module_input").find('input[type="checkbox"]').length===1){f=!f}if(i){if(c.inArray(h,e)!==-1){if(f){g.hide()}else{g.show()}}else{g.show()}}else{g.prop("disabled",f)}}});c('.ptb_change_disable input[type="radio"]:checked,.ptb_change_disable input[type="checkbox"]:checked,.ptb_change_disable select option:selected').trigger("change")},GenerateUnique:function(){return PTB.prefix+Math.random().toString(36).substr(2,9)},Escape:function(e){return e.replace(/(:|\.|\[|\]|,)/g,"\\$1")},GetEditorContent:function(e){return typeof tinymce!=="undefined"&&c("#wp-"+e+"-wrap").hasClass("tmce-active")?tinyMCE.get(e).getContent():c("#"+e).val()},SetEditorContent:function(f,e){if(!e){e=""}if(typeof tinymce!=="undefined"){tinymce.get(f).setContent(e)}c("#"+f).val(e)},ActiveEdiror:function(f){var e=c("#wp-"+f+"-wrap");if(e.hasClass("html-active")){e.find(".switch-html").trigger("click")}else{e.find(".switch-tmce").trigger("click")}},ImageUpload:function(e){var f=wp.media.frames.file_frame=wp.media({title:c(this).data("uploader_title"),button:{text:c(this).data("uploader_button_text")},library:{type:"image"},multiple:false});f.on("select",function(){var g=f.state().get("selection").first().toJSON();c(e).prev().val(g.url);c(e).closest(".ptb_post_image_wrapper").find(".ptb_post_image_thumb").css("background-image","url("+g.url+")")});f.open()},ShowHideSeperator:function(){c(a).on("change","."+PTB.prefix+"back_text input:radio",function(){var e=c(this).closest("."+PTB.prefix+"back_active_module_row").next("div");if(c(this).val()==="one_line"){e.slideDown()}else{e.slideUp()}});c("."+PTB.prefix+"back_text input:radio:checked").trigger("change")},InitTMCE:function(){setTimeout(function(){c(".switch-html").trigger("click")},1200)},InitDefaultContent:function(){if(c("."+PTB.prefix+"new-themplate").length>0){var f=c("#"+PTB.prefix+"cmb_title").clone();var e=c("#"+PTB.prefix+"cmb_editor").clone();c("."+PTB.prefix+"back_col.first ."+PTB.prefix+"module_holder").append(f).append(e).find("."+PTB.prefix+"empty_holder_text").hide()}},SetupColors:function(){var e=c("#"+PTB.prefix+"row_wrapper").find("."+PTB.prefix+"color_picker");e.each(function(){var f=PTB.RgbaToHex(c(this).data("value"));if(f&&f.indexOf("@")!==-1){f=f.split("@");c(this).val(f[0]);c(this).attr("data-opacity",f[1])}})},SetInputColor:function(e){if(!e){e=c("."+PTB.prefix+"color_picker")}e.minicolors({opacity:true,position:"top right",theme:"default",show:function(){c("."+PTB.prefix+"module_holder").sortable("disable")},hide:function(){c("."+PTB.prefix+"module_holder").sortable("enable")},create:function(f){}})},DestroyInputColor:function(){c("#"+PTB.prefix+"row_wrapper").find("."+PTB.prefix+"color_picker").minicolors("destroy")},RgbaToHex:function(e){if(!e){return false}e=e.match(/^rgba?[\s+]?\([\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?,[\s+]?(.*)[\s+]?\)/i);var f=(e&&e.length>=3)?"#"+("0"+parseInt(e[1],10).toString(16)).slice(-2)+("0"+parseInt(e[2],10).toString(16)).slice(-2)+("0"+parseInt(e[3],10).toString(16)).slice(-2):"";if(f&&e[4]){f+="@"+e[4]}return f},AddIcon:function(){c(a).delegate(".ptb-icons-list a","click",function(h){h.preventDefault();var g=c("#ptb_row_wrapper .ptb_current_ajax"),f=c(this).attr("href");g.prev("input").val("fa-"+f);c(this).closest(".ptb_admin_lightbox").find(".ptb_close_lightbox").trigger("click")})}}}(jQuery,window,document));